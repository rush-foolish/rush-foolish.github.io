## 数据库表存储及索引

> 本文主要针对sql server数据库,其他一些关系型数据库可能也适用...

- **页(page):数据存储的基本单位是页。**
为数据库中的数据文件分配的磁盘空间从逻辑上划分成页(从0到n连续编号)，磁盘的I/O操作在页级执行，且读写数据的最小单位是8KB为单位的页（1MB=128页）。
    
    每页的开头是96B的**页头**，用于存储有关页的系统信息(页码，页类型，页的可用空间，拥有该页的对象的分配单元ID)。**不同类型的数据，存储在不同类型的页里面**。

- **区(extent):8个物理上连续页的集合，来有效管理页**。如果区内的8个页属于同一个表，这种区称为**统一区**，若8个页属于不同的表，则称为**混合区**

**一个数据文件(可包含多个表)的开头分布了像GAM，SGAM(Shared Global Allocation)，PFS(Page Free Space)的管理页面**，通过这些信息知道哪些页面被使用，还可以将数据库页面串联起来。

### 表存储结构

> 每张表都对应一个object id，且每个表有一个或多个partition，每个partition有一个或多个Heap/B－tree（hobt,最多有三个分配单元用于存放数据），但每个分配单元可以有多个页。

<img src="/_images/tbstruct.png" width="60%" height="60%" />

- Data :用来存放数据
- LOB: 用来存放大型对象数据类型：text，image，xml，varchar(max)
- row overflow page: 当一条记录超过8KB,利用ROF存放超出部分的数据

**通常一个partition对应一个索引，对于每个分配单元内的数据页，根据表示否有索引，组织方式有所不同。**

**1.表中没有任何索引**
    
- 表是按照Heap(堆)的结构存储的，只有一个partition。
- 对于这个partition下的每个分配单元都有一个连接指向**IAM**(Index Allocation Map,表或索引所使用的区信息 )页。
- 数据页之间没有任何关系，通过IAM 页组织起来。对于一个select语句，**会先查询IAM,根据IAM提供的信息，遍历每个区，把区内符合条件的页返回**。若IAM损坏，表结构大乱，数据基本无法修复

<img src="/_images/heap.png" width="60%" height="60%" />

**2.表中有非聚集索引(无聚集索引)**

- 针对每个非聚集索引都有对应的一个partition
- 对于每个分配单元都有一个指向root page的连接。数据页之间通过前后指针相互联系，是一个完整的树结构
- 在结构底层，会有一个连接(文件号，页号，行号)指向真正的数据，真正的数据是以HEAP结构存放的

<img src="/_images/noncluster.png" width="60%" height="60%" />

**3.表中有有聚集索引**

- 对应的索引号是1。有一个对应的partition
- 与Noncluster相同，每个分配单元有一个链接指向根页
- 叶子节点里存放的是真正的数据，而不是指向真正数据的连接。

<img src="/_images/cluster.png" width="60%" height="60%" />

### 聚集索引和非聚集索引

#### 聚集索引

- 叶节点即实际的数据页
- 行的物理位置和行在索引中的位置是相同的
- 每个表只能有一个聚集索引,因为只能有一种排序方式

**主键和聚集索引的区别**

本质上主键是一个约束(constraint),聚集索引是表的一种存储结构

![PKvsCluster](\_images\primary_key_index.png)

#### 非聚集索引

- 基础表的数据行不按非聚集键的顺序排序和存储
- 叶层是由索引页而不是由数据页组成
- 叶节点页的次序和表的物理存储次序不同

**一个表若即有noncluster，又有cluster，创建时应先创建cluster，因为cluster索引中键值的逻辑顺序决定了表中相应行的物理顺序，创建时物理顺序会改变**

#### 使用场景对比

![scenario](\_images\scenario.png)


